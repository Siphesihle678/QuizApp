<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Excel Marks Analysis ‚Äî Auto-Graded Quiz</title>
  <style>
    :root{--bg:#f7fafc;--card:#ffffff;--accent:#0f766e;--muted:#64748b}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial; background:var(--bg);color:#0f172a}
    .container{max-width:900px;margin:20px auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    h1{font-size:20px;margin:0}
    p.lead{margin:4px 0 12px;color:var(--muted)}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,0.06);}
    .question{padding:12px;border-radius:8px;margin-bottom:10px;border:1px solid #eef2f7}
    label.qtitle{display:block;font-weight:600;margin-bottom:6px}
    textarea, input[type="text"], select{width:100%;box-sizing:border-box;padding:8px;border-radius:6px;border:1px solid #e2e8f0;font-size:14px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    button{background:var(--accent);color:white;padding:10px 14px;border-radius:10px;border:0;font-weight:600;cursor:pointer}
    button.secondary{background:#334155}
    .score{font-weight:700;font-size:18px}
    
    /* Student Info Styles */
    .student-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
        border: 1px solid #e9ecef;
    }
    .student-info h3 {
        margin: 0 0 12px 0;
        color: #495057;
        font-size: 16px;
    }
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 12px;
    }
    .form-group {
        display: flex;
        flex-direction: column;
    }
    .form-group label {
        font-weight: 600;
        margin-bottom: 4px;
        color: #495057;
        font-size: 14px;
    }
    .form-group input, .form-group select {
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 14px;
    }
    
    /* Timer Styles */
    .timer {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: 600;
        color: #856404;
    }
    .timer.warning {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }
    
    /* Progress Bar */
    .progress-container {
        background: #e9ecef;
        border-radius: 10px;
        height: 8px;
        margin-bottom: 20px;
        overflow: hidden;
    }
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s ease;
        border-radius: 10px;
    }
    
    /* Quiz Container */
    .quiz-container {
        display: none;
    }
    .quiz-container.active {
        display: block;
    }
    
    /* Results Styles */
    .results {
        background: var(--card);
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 6px 18px rgba(2,6,23,0.06);
    }
    
    /* Enhanced Results Styles */
    .detailed-results {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .results-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }
    
    .summary-item {
        background: white;
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid var(--accent);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .summary-label {
        font-weight: 500;
        color: #495057;
    }
    
    .summary-value {
        font-weight: bold;
        font-size: 1.1em;
    }
    
    .summary-value.correct {
        color: #28a745;
    }
    
    .summary-value.incorrect {
        color: #dc3545;
    }
    
    .question-analysis {
        margin-bottom: 25px;
    }
    
    .question-item {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        border-left: 4px solid #e9ecef;
    }
    
    .question-item.correct {
        border-left-color: #28a745;
        background: #f8fff9;
    }
    
    .question-item.incorrect {
        border-left-color: #dc3545;
        background: #fff8f8;
    }
    
    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .question-status {
        padding: 4px 8px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: bold;
    }
    
    .question-status.correct {
        background: #d4edda;
        color: #155724;
    }
    
    .question-status.incorrect {
        background: #f8d7da;
        color: #721c24;
    }
    
    .answer-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 10px;
    }
    
    .answer-box {
        padding: 10px;
        border-radius: 8px;
        border: 2px solid #e9ecef;
    }
    
    .answer-box.correct {
        border-color: #28a745;
        background: #d4edda;
    }
    
    .answer-box.incorrect {
        border-color: #dc3545;
        background: #f8d7da;
    }
    
    .answer-label {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 0.9em;
    }
    
    .answer-text {
        color: #495057;
    }
    
    .explanation {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 15px;
        margin-top: 10px;
        border-radius: 0 8px 8px 0;
    }
    
    .explanation h4 {
        color: #1976d2;
        margin-bottom: 8px;
        font-size: 1em;
    }
    
    .explanation p {
        color: #424242;
        margin: 0;
        line-height: 1.5;
    }
    
    .action-buttons {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-primary {
        background: var(--accent);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(15, 118, 110, 0.3);
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }
    
    /* All Questions Review Styles */
    .all-questions-review {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .review-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
        flex-wrap: wrap;
    }
    
    .questions-container {
        max-height: 600px;
        overflow-y: auto;
    }
    
    .review-question {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid var(--accent);
    }
    
    .review-question h4 {
        color: #2c3e50;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .review-options {
        margin-bottom: 15px;
    }
    
    .review-option {
        padding: 8px 12px;
        margin-bottom: 5px;
        border-radius: 5px;
        border: 2px solid #e9ecef;
    }
    
    .review-option.correct {
        border-color: #28a745;
        background: #d4edda;
        font-weight: bold;
    }
    
    .review-option.selected {
        border-color: var(--accent);
        background: #e3f2fd;
    }
    
    .review-option.selected.incorrect {
        border-color: #dc3545;
        background: #f8d7da;
    }
    
    @media print {
        .action-buttons, .review-controls {
            display: none !important;
        }
        
        .container {
            box-shadow: none;
            border-radius: 0;
        }
        
        .detailed-results, .all-questions-review {
            background: white;
            border-radius: 0;
        }
    }
        background: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 8px;
        padding: 16px;
        margin-top: 20px;
        text-align: center;
    }
    .results h3 {
        margin: 0 0 12px 0;
        color: #155724;
    }
    .score-display {
        font-size: 24px;
        font-weight: 700;
        color: #155724;
        margin-bottom: 8px;
    }
    .feedback {
        color: #155724;
        font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="card" style="padding:12px;display:flex;align-items:center;gap:12px">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M3 7a2 2 0 0 1 2-2h3l2 2h7a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H8l-2 2H5a2 2 0 0 1-2-2V7z" stroke="#0f766e" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <div>
          <h1>Excel ‚Äî Student Marks Analysis Quiz</h1>
          <p class="lead">Test your Excel skills with this auto-graded quiz. Answer questions about Excel functions and get instant feedback.</p>
        </div>
      </div>
    </header>

    <!-- Student Information Form -->
    <div class="card" id="studentForm">
      <h3>üìù Student Information</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="studentName">Full Name *</label>
          <input type="text" id="studentName" required>
        </div>
        <div class="form-group">
          <label for="studentEmail">Email Address *</label>
          <input type="email" id="studentEmail" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="studentGrade">Grade *</label>
          <select id="studentGrade" required>
            <option value="">Select Grade</option>
            <option value="10">Grade 10</option>
            <option value="11">Grade 11</option>
            <option value="12">Grade 12</option>
          </select>
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <button type="button" id="startQuiz" style="width: 100%;">Start Excel Quiz</button>
        </div>
      </div>
    </div>

    <!-- Timer and Progress -->
    <div class="timer" id="timer" style="display: none;">
      <div>‚è±Ô∏è Time Remaining: <span id="timeDisplay">15:00</span></div>
    </div>
    
    <div class="progress-container" id="progressContainer" style="display: none;">
      <div class="progress-bar" id="progressBar" style="width: 0%"></div>
    </div>

    <!-- Quiz Content -->
    <main class="card quiz-container" id="quizContainer">
      <form id="quiz">
        <div class="question"><label class="qtitle">1) What does the SUM function do in Excel?</label><textarea id="q1" rows="2"></textarea></div>
        <div class="question"><label class="qtitle">2) Write the formula to calculate the average of cells D2 to F2.</label><input type="text" id="q2" /></div>
        <div class="question"><label class="qtitle">3) How would you use IF to display "Pass" if a score in H2 is 50 or more, otherwise "Fail"?</label><input type="text" id="q3" /></div>
        <div class="question"><label class="qtitle">4) Explain what a nested IF formula is used for.</label><textarea id="q4" rows="2"></textarea></div>
        <div class="question"><label class="qtitle">5) Which function would you use to find the highest score in a column?</label><input type="text" id="q5" /></div>
        <div class="question"><label class="qtitle">6) Describe how COUNTIF works and give one example.</label><textarea id="q6" rows="2"></textarea></div>
        <div class="question"><label class="qtitle">7) What does CONCATENATE do?</label><textarea id="q7" rows="2"></textarea></div>
        <div class="question"><label class="qtitle">8) Which function can retrieve data from another table based on a matching value?</label><input type="text" id="q8" /></div>
        <div class="question"><label class="qtitle">9) How would you highlight all scores below 40 using Conditional Formatting?</label><textarea id="q9" rows="2"></textarea></div>

        <div class="controls">
          <button type="button" id="check">Check Answers</button>
          <button type="button" id="submit" style="display: none;">Submit Quiz</button>
        </div>
      </form>

      <div id="out" style="margin-top:12px"></div>
    </main>
  </div>

  <script>
    const answers = [
      "It adds up the numbers in the selected cells.",
      "=AVERAGE(D2:F2)",
      "=IF(H2>=50,\"Pass\",\"Fail\")",
      "A formula that uses multiple IF statements inside each other to test several conditions.",
      "=MAX(column_range)",
      "Counts the number of cells that meet a condition, e.g., =COUNTIF(A1:A10,\">50\")",
      "Combines text from two or more cells into one.",
      "VLOOKUP",
      "Select the cells ‚Üí Conditional Formatting ‚Üí New Rule ‚Üí Cell Value < 40 ‚Üí Apply formatting."
    ];

    let startTime = null;
    let timerInterval = null;
    const quizDuration = 15 * 60; // 15 minutes in seconds

    // Start Quiz Button
    document.getElementById('startQuiz').addEventListener('click', function() {
      const name = document.getElementById('studentName').value.trim();
      const email = document.getElementById('studentEmail').value.trim();
      const grade = document.getElementById('studentGrade').value;

      if (!name || !email || !grade) {
        alert('Please fill in all required fields.');
        return;
      }

      // Hide student form and show quiz
      document.getElementById('studentForm').style.display = 'none';
      document.getElementById('quizContainer').classList.add('active');
      document.getElementById('timer').style.display = 'block';
      document.getElementById('progressContainer').style.display = 'block';

      // Start timer
      startTime = Date.now();
      startTimer();
    });

    // Timer function
    function startTimer() {
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const remaining = quizDuration - elapsed;
        
        if (remaining <= 0) {
          clearInterval(timerInterval);
          submitQuiz();
          return;
        }

        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        document.getElementById('timeDisplay').textContent = 
          `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        // Warning when less than 5 minutes remaining
        if (remaining < 300) {
          document.getElementById('timer').classList.add('warning');
        }

        // Update progress bar
        const progress = ((quizDuration - remaining) / quizDuration) * 100;
        document.getElementById('progressBar').style.width = `${progress}%`;
      }, 1000);
    }

    // Check Answers Button
    document.getElementById('check').addEventListener('click', function() {
      const out = document.getElementById('out');
      out.innerHTML = '';
      let total = 0;
      let correctAnswers = [];
      let incorrectAnswers = [];

      answers.forEach((ans, i) => {
        const val = document.getElementById(`q${i+1}`).value.trim().toLowerCase();
        const correct = ans.toLowerCase();
        
        if (val === correct) {
          total++;
          correctAnswers.push(i + 1);
        } else {
          incorrectAnswers.push({
            question: i + 1,
            studentAnswer: val,
            correctAnswer: ans
          });
        }
      });

      const percentage = Math.round((total / answers.length) * 100);
      
      out.innerHTML = `
        <div class='results'>
          <h3>Quiz Results</h3>
          <div class='score-display'>Score: ${total}/${answers.length} (${percentage}%)</div>
          <div class='feedback'>
            ${total === answers.length ? 'üéâ Perfect! All answers correct!' : 
              `You got ${total} out of ${answers.length} questions correct.`}
          </div>
        </div>
      `;

      // Show submit button
      document.getElementById('submit').style.display = 'inline-block';
    });

    // Submit Quiz Button
    document.getElementById('submit').addEventListener('click', submitQuiz);

    function submitQuiz() {
      clearInterval(timerInterval);
      
      const name = document.getElementById('studentName').value.trim();
      const email = document.getElementById('studentEmail').value.trim();
      const grade = document.getElementById('studentGrade').value;
      
      let total = 0;
      let studentAnswers = [];
      let incorrectAnswers = [];

      answers.forEach((ans, i) => {
        const val = document.getElementById(`q${i+1}`).value.trim();
        studentAnswers.push(val);
        
        if (val.toLowerCase() === ans.toLowerCase()) {
          total++;
        } else {
          incorrectAnswers.push({
            question: i + 1,
            studentAnswer: val,
            correctAnswer: ans
          });
        }
      });

      const percentage = Math.round((total / answers.length) * 100);
      const timeUsed = Math.floor((Date.now() - startTime) / 1000);

      const quizData = {
        studentName: name,
        studentEmail: email,
        studentGrade: grade,
        score: total,
        totalQuestions: answers.length,
        percentage: percentage,
        timeUsed: timeUsed,
        answers: studentAnswers,
        incorrectAnswers: incorrectAnswers
      };

      // Submit to backend
      submitToBackend(quizData);

      // Show final results with enhanced details
      document.getElementById('out').innerHTML = `
        <div class='results'>
          <h3>üéâ Quiz Completed!</h3>
          <div class='score-display'>Final Score: ${total}/${answers.length} (${percentage}%)</div>
          <div class='feedback'>
            Time used: ${Math.floor(timeUsed / 60)}:${(timeUsed % 60).toString().padStart(2, '0')}<br>
            Your results have been saved successfully!
          </div>
          
          <!-- Enhanced Results Section -->
          <div class="detailed-results">
            <h3>üìã Detailed Question Analysis</h3>
            <div class="results-summary">
              <div class="summary-item">
                <span class="summary-label">Total Questions:</span>
                <span class="summary-value">${answers.length}</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Correct Answers:</span>
                <span class="summary-value correct">${total}</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Incorrect Answers:</span>
                <span class="summary-value incorrect">${answers.length - total}</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Time Used:</span>
                <span class="summary-value">${Math.floor(timeUsed / 60)}:${(timeUsed % 60).toString().padStart(2, '0')}</span>
              </div>
            </div>
            
            <div class="question-analysis" id="questionAnalysis">
              <!-- Question analysis will be populated here -->
            </div>
            
            <div class="action-buttons">
              <button class="btn btn-primary" onclick="showAllQuestions()">üìñ View All Questions & Answers</button>
              <button class="btn btn-secondary" onclick="retakeQuiz()">üîÑ Retake Quiz</button>
              <button class="btn btn-secondary" onclick="downloadResults()">üì• Download Results</button>
            </div>
          </div>
          
          <!-- All Questions Review Section -->
          <div class="all-questions-review" id="allQuestionsReview" style="display: none;">
            <h3>üìö Complete Question Review</h3>
            <div class="review-controls">
              <button class="btn btn-secondary" onclick="showDetailedResults()">‚Üê Back to Results</button>
              <button class="btn btn-primary" onclick="printReview()">üñ®Ô∏è Print Review</button>
            </div>
            <div class="questions-container" id="questionsContainer">
              <!-- All questions with explanations will be populated here -->
            </div>
          </div>
        </div>
      `;

      // Generate detailed analysis
      generateDetailedAnalysis(quizData);

      // Disable form
      document.querySelectorAll('#quiz input, #quiz textarea').forEach(input => {
        input.disabled = true;
      });
      document.getElementById('check').disabled = true;
      document.getElementById('submit').disabled = true;
    }

    function submitToBackend(quizData) {
      // Submit to Railway backend API
      fetch('/api/submit-excel', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(quizData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log('Quiz submitted successfully');
        } else {
          console.error('Error submitting quiz:', data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        // Fallback to localStorage
        const submissions = JSON.parse(localStorage.getItem('excelQuizSubmissions') || '[]');
        submissions.push(quizData);
        localStorage.setItem('excelQuizSubmissions', JSON.stringify(submissions));
      });
    }

    // Excel Quiz Question Explanations
    const excelQuestionExplanations = {
      1: {
        question: "What is the primary purpose of Excel's SUM function?",
        correct: "To add up a range of numbers",
        explanation: "The SUM function is Excel's most basic mathematical function, designed specifically to add up values in a range of cells. It's essential for basic calculations and is used extensively in financial and data analysis."
      },
      2: {
        question: "Which Excel feature allows you to automatically fill data based on a pattern?",
        correct: "AutoFill",
        explanation: "AutoFill is Excel's intelligent feature that recognizes patterns in your data and automatically fills adjacent cells. It works with numbers, dates, text, and even custom lists."
      },
      3: {
        question: "What does the AVERAGE function calculate?",
        correct: "The arithmetic mean of a range of numbers",
        explanation: "The AVERAGE function calculates the arithmetic mean by summing all values in a range and dividing by the count of values. It's commonly used for statistical analysis and performance metrics."
      },
      4: {
        question: "Which chart type is best for showing trends over time?",
        correct: "Line chart",
        explanation: "Line charts are ideal for displaying trends over time because they clearly show how values change continuously. They're perfect for tracking performance, sales, or any time-series data."
      },
      5: {
        question: "What is the purpose of cell references in formulas?",
        correct: "To refer to data in other cells",
        explanation: "Cell references allow formulas to dynamically use data from other cells. This makes spreadsheets flexible and reusable, as changing input values automatically updates calculated results."
      },
      6: {
        question: "Which function counts the number of cells containing numbers?",
        correct: "COUNT",
        explanation: "The COUNT function specifically counts cells that contain numeric values. It's useful for determining how many data points you have in a dataset."
      },
      7: {
        question: "What does the MAX function return?",
        correct: "The highest value in a range",
        explanation: "The MAX function identifies the highest (largest) value in a specified range. It's commonly used in data analysis to find peak values or best performance metrics."
      },
      8: {
        question: "Which Excel feature helps prevent data entry errors?",
        correct: "Data validation",
        explanation: "Data validation allows you to set rules for what can be entered in cells, helping maintain data integrity and preventing common input errors."
      },
      9: {
        question: "What is the purpose of conditional formatting?",
        correct: "To highlight cells based on their values",
        explanation: "Conditional formatting automatically applies formatting (colors, icons, bars) to cells based on their values or formulas. It makes it easy to spot trends, outliers, and important data."
      },
      10: {
        question: "Which function finds the position of a value in a range?",
        correct: "MATCH",
        explanation: "The MATCH function returns the relative position of an item in a range. It's often used with INDEX to create powerful lookup formulas."
      }
    };

    function generateDetailedAnalysis(quizData) {
      const questionAnalysis = document.getElementById('questionAnalysis');
      questionAnalysis.innerHTML = '';

      // Create analysis for each question
      for (let i = 1; i <= answers.length; i++) {
        const studentAnswer = document.getElementById(`q${i}`).value.trim();
        const correctAnswer = answers[i - 1];
        const isCorrect = studentAnswer.toLowerCase() === correctAnswer.toLowerCase();
        const explanation = excelQuestionExplanations[i];

        const questionItem = document.createElement('div');
        questionItem.className = `question-item ${isCorrect ? 'correct' : 'incorrect'}`;
        
        questionItem.innerHTML = `
          <div class="question-header">
            <span class="question-number">Question ${i}</span>
            <span class="question-status ${isCorrect ? 'correct' : 'incorrect'}">
              ${isCorrect ? '‚úì Correct' : '‚úó Incorrect'}
            </span>
          </div>
          <div class="question-text">${explanation.question}</div>
          <div class="answer-comparison">
            <div class="answer-box ${isCorrect ? 'correct' : 'incorrect'}">
              <div class="answer-label">Your Answer:</div>
              <div class="answer-text">${studentAnswer || 'Not answered'}</div>
            </div>
            <div class="answer-box correct">
              <div class="answer-label">Correct Answer:</div>
              <div class="answer-text">${explanation.correct}</div>
            </div>
          </div>
          <div class="explanation">
            <h4>üí° Explanation:</h4>
            <p>${explanation.explanation}</p>
          </div>
        `;

        questionAnalysis.appendChild(questionItem);
      }
    }

    function showAllQuestions() {
      document.querySelector('.detailed-results').style.display = 'none';
      document.getElementById('allQuestionsReview').style.display = 'block';
      
      const questionsContainer = document.getElementById('questionsContainer');
      questionsContainer.innerHTML = '';

      // Create review for each question
      for (let i = 1; i <= answers.length; i++) {
        const studentAnswer = document.getElementById(`q${i}`).value.trim();
        const correctAnswer = answers[i - 1];
        const isCorrect = studentAnswer.toLowerCase() === correctAnswer.toLowerCase();
        const explanation = excelQuestionExplanations[i];

        const reviewQuestion = document.createElement('div');
        reviewQuestion.className = 'review-question';
        
        reviewQuestion.innerHTML = `
          <h4>
            <span class="question-number">Question ${i}</span>
            <span class="question-status ${isCorrect ? 'correct' : 'incorrect'}">
              ${isCorrect ? '‚úì Correct' : '‚úó Incorrect'}
            </span>
          </h4>
          <div class="question-text">${explanation.question}</div>
          <div class="answer-comparison">
            <div class="answer-box ${isCorrect ? 'correct' : 'incorrect'}">
              <div class="answer-label">Your Answer:</div>
              <div class="answer-text">${studentAnswer || 'Not answered'}</div>
            </div>
            <div class="answer-box correct">
              <div class="answer-label">Correct Answer:</div>
              <div class="answer-text">${explanation.correct}</div>
            </div>
          </div>
          <div class="explanation">
            <h4>üí° Explanation:</h4>
            <p>${explanation.explanation}</p>
          </div>
        `;

        questionsContainer.appendChild(reviewQuestion);
      }
    }

    function showDetailedResults() {
      document.getElementById('allQuestionsReview').style.display = 'none';
      document.querySelector('.detailed-results').style.display = 'block';
    }

    function retakeQuiz() {
      // Reset form
      document.getElementById('quiz').reset();
      
      // Reset timer
      startTime = Date.now();
      updateTimer();
      
      // Show quiz form
      document.getElementById('quiz').style.display = 'block';
      document.querySelector('.student-info').style.display = 'block';
      document.querySelector('.timer').style.display = 'block';
      
      // Hide results
      document.getElementById('out').innerHTML = '';
      
      // Enable form
      document.querySelectorAll('#quiz input, #quiz textarea').forEach(input => {
        input.disabled = false;
      });
      document.getElementById('check').disabled = false;
      document.getElementById('submit').style.display = 'none';
      
      // Start timer
      startTimer();
    }

    function downloadResults() {
      const quizData = {
        studentName: document.getElementById('studentName').value,
        studentEmail: document.getElementById('studentEmail').value,
        studentGrade: document.getElementById('studentGrade').value,
        score: document.querySelector('.score-display').textContent,
        date: new Date().toLocaleDateString(),
        time: document.querySelector('.summary-value:last-child').textContent
      };

      const dataStr = JSON.stringify(quizData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `excel_quiz_results_${quizData.studentName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
    }

    function printReview() {
      window.print();
    }
  </script>
</body>
</html>
